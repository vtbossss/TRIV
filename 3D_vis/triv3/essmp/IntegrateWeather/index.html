<head>
    <style> 
      body { margin: 0; } 
      #weather-data { position: absolute; top: 10px; left: 10px; background: rgba(255, 255, 255, 0.8); padding: 10px; border-radius: 8px; z-index: 1000; }
    </style>
    <script src="//unpkg.com/3d-force-graph"></script>
  </head>
  
  <body>
    <header>
      <h1>Weather Data Visualization</h1>
    </header>
  
    <div id="weather-data">
      <p class="status-message">Waiting for data...</p>
    </div>
    
    <div id="3d-graph" style="width: 100vw; height: 100vh;"></div>
  
    <script>
      // Initialize WebSocket for Weather Data
      const socket = new WebSocket('ws://' + window.location.hostname + ':8000/ws/weather/');
      console.log('WebSocket initialized, waiting for weather data...');
  
      // Initialize the 3D Force Graph
      const graphContainer = document.getElementById('3d-graph');
      const Graph = ForceGraph3D()(graphContainer)
        .nodeAutoColorBy('group')  // Color nodes by their group
        .linkOpacity(0.5);  // Set link opacity
  
      // Placeholder for graph data
      const gData = {
        nodes: [], // Nodes array
        links: []  // Links array
      };
  
      socket.onopen = function () {
        console.log('WebSocket connection established');
        updateStatusMessage('Connected to server, awaiting weather data...');
      };
  
      socket.onmessage = function (e) {
        console.log('Message received from WebSocket:', e.data);
  
        try {
          const data = JSON.parse(e.data);
  
          // Validate and parse weather data
          if (data && data.weather && data.weather.main && data.weather.wind && data.weather.weather && data.weather.dt) {
            const weatherMain = data.weather.main;
            const weatherWind = data.weather.wind;
            const weatherDescription = data.weather.weather[0];
            const timestamp = data.weather.dt;
  
            // Convert timestamp
            let formattedTimestamp = 'N/A';
            if (!isNaN(timestamp)) {
              formattedTimestamp = new Date(timestamp * 1000).toLocaleString();
            }
  
            // Update the weather data UI
            document.getElementById('weather-data').innerHTML = `
              <div class="data-field">
                <strong>Temperature:</strong> ${(weatherMain.temp - 273.15).toFixed(2)} Â°C
              </div>
              <div class="data-field">
                <strong>Humidity:</strong> ${weatherMain.humidity} %
              </div>
              <div class="data-field">
                <strong>Wind Speed:</strong> ${weatherWind.speed} m/s
              </div>
              <div class="data-field">
                <strong>Pressure:</strong> ${weatherMain.pressure} hPa
              </div>
              <div class="data-field">
                <strong>Weather:</strong> ${weatherDescription.main} (${weatherDescription.description})
              </div>
              <div class="data-field">
                <strong>Timestamp:</strong> ${formattedTimestamp}
              </div>
            `;
  
            // Map weather data to nodes and links
            const nodes = [
              { id: 'Temperature', group: 1, value: weatherMain.temp },
              { id: 'Humidity', group: 2, value: weatherMain.humidity },
              { id: 'Wind Speed', group: 3, value: weatherWind.speed },
              { id: 'Pressure', group: 4, value: weatherMain.pressure },
              { id: `Timestamp ${formattedTimestamp}`, group: 5 }
            ];
  
            const links = [
              { source: 'Temperature', target: 'Humidity', group: 1 },
              { source: 'Humidity', target: 'Wind Speed', group: 2 },
              { source: 'Wind Speed', target: 'Pressure', group: 3 },
              { source: 'Pressure', target: `Timestamp ${formattedTimestamp}`, group: 4 }
            ];
  
            // Update graph data
            gData.nodes = nodes;
            gData.links = links;
  
            // Refresh the graph visualization
            Graph.graphData(gData);
            console.log('Graph updated with new weather data');
          } else {
            console.warn('Invalid data format received');
            updateStatusMessage('Received invalid or incomplete data. Please try again later.');
          }
        } catch (error) {
          console.error('Error parsing WebSocket data:', error);
        }
      };
  
      socket.onclose = function (e) {
        console.error('WebSocket closed unexpectedly', e);
        updateStatusMessage('Connection closed. Please try again later.');
      };
  
      socket.onerror = function (e) {
        console.error('WebSocket error:', e);
        updateStatusMessage('Error connecting to the server. Please check your connection.');
      };
  
      function updateStatusMessage(message) {
        const weatherDataElement = document.getElementById('weather-data');
        weatherDataElement.innerHTML = `<p class="status-message">${message}</p>`;
      }
    </script>
  </body>
  